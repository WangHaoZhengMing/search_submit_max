use anyhow::{Context, Result};
use serde_json::json;
use tracing::info;

use crate::api::send_request::{ send_api_request_with_own_cookie};

pub async fn submit_paper(paper_id: &str) -> Result<()> {
    let url = "https://tps-tiku-api.staff.xdf.cn/paper/process/submit";

    let payload = json!({
        "paperId": paper_id,
        "type": "NEW_INPUT"
    });

    info!("开始提交试卷, paperId: {}", paper_id);

    let response = send_api_request_with_own_cookie(url, &payload)
        .await
        .with_context(|| format!("提交试卷失败 paperId: {}", paper_id))?;

    println!("{:?}", response);

    info!("试卷提交成功: {:?}", response);

    Ok(())
}


#[tokio::test]
async fn test_submit_paper() {
    let paper_id = "3438372587212120064";
    let result = submit_paper(paper_id).await;
    assert!(result.is_ok());
}

#[tokio::test]
async fn test_sumbit_miti_paper(){
    use futures::StreamExt;

    let paperid_list = vec![
        "3438293346655948800",
"3438351165945290752",
"3438299735252029440",
"3438267834200592384",
"3438266907088932864",
"3438343886123323392",
"3438355109898981376",
"3438267375727697920",
"3438297001590022144",
"3438298049682087936",
"3438265687539027968",
"3438296596336369664",
"3438273504228511744",
"3438287469499916288",
"3438279625781645312",
"3438266432210624512",
"3438294210850344960",
"3438291333054484480",
"3438277361813786624",
"3438272235885846528",
"3438298572727881728",
"3438266368473980928",
"3438290733809278976",
"3438281539106381824",
"3438326493519040512",
"3438326487415529472",
"3438331877512994816",
"3438325374331133952",
"3438331241404850176",
"3438326521137041408",
"3438330305422659584",
"3438325471300046848",
"3438331442465611776",
"3438340104626118656",
"3438328117150896128",
"3438331871357669376",
"3438324424387694592",
"3438324427357954048",
"3438328006605819904",
"3438329176867758080",
"3438328618003828736",
"3438330264097673216",
"3438341212673953792",
"3438327293038059520",
"3438325571980910592",
"3438326460904132608",
"3438335601786511360",
"3438325373975416832",
"3438324431518703616",
"3438331217279213568",
"3438324413547700224",
"3438325362433482752",
"3438326491606437888",
"3438324458530021376",
"3438324426015776768",
"3438330248243204096",
"3438328629933121536",
"3438330305574346752",
"3438329638512238592",
"3438323685888200704",
"3438323735313879040",
"3438323667632676864",
"3438323708570996736",
"3438325335505260544",
"3438325410519588864",
"3438323682849611776",
"3438363927618527232",
"3438299110790668288",
"3438323704276721664",
"3438306618239901696",
"3438305698244485120",
"3438304205611044864",
"3438306591950004224",
"3438305208536932352",
"3438306570424045568",
"3438306636392058880",
"3438307154171289600",
"3438303430668734464",
"3438304316256784384",
"3438303418289852416",
"3438305237561516032",
"3438305180149882880",
"3438304226784583680",
"3438305167130071040",
"3438306596966391808",
"3438304205088247808",
"3438303388510294016",
"3438304241212297216",
"3438303373830230016",
"3438303380608225280",
"3438307163918061568",
"3438305219758284800",
"3438306630372433920",
"3438304212355485696",
"3438305727016620032",
"3438306696806813696",
"3438305750675890176",
"3438305145250668544",
"3438304195005931520",
"3438303445986332672",
"3438306698587901952",
"3438305227981033472",
"3438306642701082624",
"3438306598344036352",
"3438305191306039296",
"3438292266239496192",
"3438293773353586688",
"3438292751753437184",
"3438293304427696128",
"3438293343720726528",
"3438293337331212288",
"3438295073434128384",
"3438292280349134848",
"3438286476003516416",
"3438287987378327552",
"3438286537387954176",
"3438283864377495552",
"3438285990199054336",
"3438286477494083584",
"3438289564232601600",
"3438282775114043392",
"3438288496399060992",
"3438285904837369856",
"3438282772617633792",
"3438282794727399424",
"3438285913678172160",
"3438285931029209088",
"3438283267458224128",
"3438285910742159360",
"3438283790373888000",
"3438284561536016384",
"3438288495509868544",
"3438289540428435456",
"3438282795266183168",
"3438285298728800256",
"3438283966870200320",
"3438284571151966208",
"3438284703775858688",
"3438286905080815616",
"3438287463221841920",
"3438283824462585856",
"3438282049233719296",
"3438282789863919616",
"3438285230895812608",
"3438289098315239424",
"3438287923237117952",
"3438282773068013568",
"3438288562028826624",
"3438289078183272448",
"3438287486226108416",
"3438370121229111296",
"3438358879638753280",
"3438346550681559040",
"3438370645195640832",
"3438266890398998528",
"3438284588396339200",
"3438355858246701056",
"3438300318330097664",
"3438296067115868160",

    ];

    futures::stream::iter(paperid_list)
        .map(|paper_id| async move {
            let result = submit_paper(paper_id).await;
            if let Err(e) = &result {
                println!("提交失败 {}: {:?}", paper_id, e);
            }
            assert!(result.is_ok());
        })
        .buffer_unordered(10)
        .collect::<Vec<_>>()
        .await;
}