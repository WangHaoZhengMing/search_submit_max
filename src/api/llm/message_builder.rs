use tracing::{debug, warn};

use crate::api::search::SearchResult;

/// æ„å»ºç”¨äºé¢˜ç›®åŒ¹é…çš„æ¶ˆæ¯
/// æ³¨æ„ï¼šç°åœ¨æ˜¯ async fn
pub async fn build_send_messages(
    search_results: &[SearchResult],
    target_img: &str, 
) -> (String, String, Vec<String>) {
    let mut all_images_to_send = Vec::new();

    // 1. æ·»åŠ ç›®æ ‡é¢˜ç›®æˆªå›¾ï¼ˆImage 1ï¼‰
    all_images_to_send.push(target_img.to_string());

    // è®°å½•å½“å‰å›¾ç‰‡ç´¢å¼•ï¼ˆä» Image 2 å¼€å§‹ç»™å€™é€‰é¢˜ç›®ï¼‰
    let mut current_img_index = 1;

    // 2. å¤„ç†å€™é€‰é¢˜ç›®åˆ—è¡¨
    let mut candidates_vec = Vec::new();

    for (idx, result) in search_results.iter().enumerate() {
        let mut candidate = serde_json::json!({
            "index": idx,
            "content": &result.question_content,
            "similarity": result.xkw_question_similarity,
        });

        let img_ref_str;

        if let Some(c_imgs) = &result.img_urls {
            if !c_imgs.is_empty() {
                // å†³å®šæœ€ç»ˆè¦å‘å“ªäº›å›¾
                let final_imgs_for_this_candidate: Vec<String>;

                if c_imgs.len() > 1 {
                    // å°è¯•åˆå¹¶å¤šå¼ å›¾ç‰‡
                    match super::image_merger::smart_merge_images(c_imgs).await {
                        Ok(merged_imgs) => {
                            // åˆå¹¶æˆåŠŸï¼ˆå¯èƒ½è¿”å› 1 å¼ ï¼Œä¹Ÿå¯èƒ½å› ä¸ºå¤ªé«˜è¿”å›å¤šå¼ ï¼‰
                            debug!(
                                "å€™é€‰é¢˜ç›® {} çš„ {} å¼ å›¾ç‰‡åˆå¹¶ä¸º {} å¼ ",
                                idx,
                                c_imgs.len(),
                                merged_imgs.len()
                            );
                            final_imgs_for_this_candidate = merged_imgs;
                        }
                        Err(e) => {
                            // é™çº§ç­–ç•¥ï¼šå¦‚æœä¸‹è½½/åˆå¹¶å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹ URL åˆ—è¡¨
                            warn!(
                                "å€™é€‰é¢˜ç›® {} å›¾ç‰‡åˆå¹¶å¤±è´¥: {}, å›é€€åˆ°åŸå§‹ {} å¼ å›¾ç‰‡",
                                idx,
                                e,
                                c_imgs.len()
                            );
                            final_imgs_for_this_candidate = c_imgs.to_vec();
                        }
                    }
                } else {
                    // å•å¼ å›¾ç‰‡ç›´æ¥ä½¿ç”¨
                    final_imgs_for_this_candidate = c_imgs.to_vec();
                }

                // å°†å¤„ç†åçš„å›¾ç‰‡ï¼ˆBase64 æˆ– URLï¼‰åŠ å…¥æ€»åˆ—è¡¨
                all_images_to_send.extend(final_imgs_for_this_candidate.clone());

                // è®¡ç®—ç´¢å¼•èŒƒå›´
                let start = current_img_index + 1;
                let end = current_img_index + final_imgs_for_this_candidate.len();
                current_img_index = end;

                // ç”Ÿæˆæè¿°
                if start == end {
                    img_ref_str = format!("Image {}", start);
                } else {
                    img_ref_str = format!("Image {} åˆ° Image {}", start, end);
                }
            } else {
                img_ref_str = "æ— å›¾ç‰‡".to_string();
            }
        } else {
            img_ref_str = "æ— å›¾ç‰‡".to_string();
        }

        candidate["image_ref"] = serde_json::json!(img_ref_str);
        candidates_vec.push(candidate);
    }

    let candidates_json = serde_json::to_string_pretty(&candidates_vec).unwrap_or_default();

    // 3. æ„1Prompt
    let system_message = "ä½ æ˜¯ä¸€ä¸ªé«˜ç²¾åº¦çš„è¯•é¢˜æŸ¥é‡ä¸“å®¶ï¼Œæ“…é•¿å¤„ç†ç†ç§‘å’Œæ–‡ç§‘é¢˜ç›®ã€‚\
                         ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯åŒºåˆ†ã€å®Œå…¨ç›¸åŒçš„åŸé¢˜ã€‘ä¸ã€ç›¸ä¼¼çš„æ”¹ç¼–é¢˜ã€‘ã€‚\
                         ä½ éœ€è¦å…·å¤‡æå¼ºçš„æŠ—å¹²æ‰°èƒ½åŠ›ï¼Œèƒ½å¿½ç•¥æ ¼å¼å·®å¼‚å’ŒOCRè½»å¾®é”™è¯¯ï¼Œä½†å¯¹é¢˜ç›®æ ¸å¿ƒå†…å®¹çš„å˜åŒ–æå…¶æ•æ„Ÿã€‚".to_string();

    let user_message = format!(
        r#"è¯·åœ¨ã€å€™é€‰åˆ—è¡¨ã€‘ä¸­æ‰¾å‡ºä¸ã€ç›®æ ‡é¢˜ç›®ã€‘å±äºåŒä¸€é“åŸé¢˜çš„é€‰é¡¹ã€‚

ã€å›¾ç‰‡ç´¢å¼•è¯´æ˜ã€‘
å…±å‘é€ {} å¼ å›¾ç‰‡ã€‚è¯·ä¸¥æ ¼å¯¹åº”å›¾ç‰‡ç´¢å¼•è¿›è¡ŒæŸ¥çœ‹ã€‚

ã€ç›®æ ‡é¢˜ç›®ã€‘
å›¾ç‰‡ç´¢å¼•ï¼šImage 1
ï¼ˆè¿™æ˜¯ç›®æ ‡é¢˜ç›®çš„å®Œæ•´æˆªå›¾ï¼Œè¯·ä»”ç»†æŸ¥çœ‹ï¼‰

ã€å€™é€‰é¢˜ç›®åˆ—è¡¨ã€‘
{}

ã€æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ - è¯·é’ˆå¯¹é¢˜å‹é‡‡å–ä¸åŒç­–ç•¥ã€‘

**åœºæ™¯ä¸€ï¼šå¦‚æœæ˜¯ç†ç§‘é¢˜ï¼ˆæ•°å­¦/ç‰©ç†/åŒ–å­¦ç­‰ï¼‰**
1. **æ•°å€¼ç»å¯¹åŒ¹é…**ï¼šé¢˜å¹²ä¸­çš„æ•°å­—ã€å…¬å¼ç³»æ•°ã€ç‰©ç†é‡å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚
   - ğŸš« æ‹’ç»ï¼šæ•°å­—ç”± "10" å˜ä¸º "20"ï¼Œæˆ– "æœ€å¤§å€¼" å˜ä¸º "æœ€å°å€¼"ï¼ˆè¿™æ˜¯æ”¹ç¼–é¢˜ï¼‰ã€‚
2. **ç¬¦å·ä¸å›¾å½¢**ï¼šå˜é‡åï¼ˆx, yï¼‰å’Œå‡ ä½•å›¾ç»“æ„å¿…é¡»ä¸€è‡´ã€‚

**åœºæ™¯äºŒï¼šå¦‚æœæ˜¯æ–‡ç§‘é¢˜ï¼ˆè¯­æ–‡/è‹±è¯­/å†å²/æ”¿æ²»ç­‰ï¼‰**
1. **æ–‡æœ¬æŒ‡çº¹åŒ¹é…**ï¼š
   - é‡ç‚¹æ ¸å¯¹ï¼šå¤è¯—æ–‡å¡«ç©ºã€è‹±è¯­é˜…è¯»ç†è§£çš„åŸæ–‡ã€é€‰æ‹©é¢˜çš„**å…·ä½“é€‰é¡¹å†…å®¹**ã€‚
   - ğŸš« æ‹’ç»ï¼šå¦‚æœæ–‡ç« ä¸»é¢˜ç›¸åŒï¼Œä½†**è®¾é—®æ–¹å¼ä¸åŒ**ï¼ˆä¾‹å¦‚é—®"ä¸»æ—¨"å˜æˆäº†é—®"ç»†èŠ‚"ï¼‰ï¼Œè¿™æ˜¯æ”¹ç¼–é¢˜ã€‚
   - ğŸš« æ‹’ç»ï¼šè‹±è¯­å®Œå½¢å¡«ç©ºå¦‚æœæŒ–ç©ºçš„**ä½ç½®ä¸åŒ**ï¼Œè¿™æ˜¯æ”¹ç¼–é¢˜ã€‚
2. **å®¹é”™æœºåˆ¶ï¼ˆé’ˆå¯¹ OCR è¯¯å·®ï¼‰**ï¼š
   - âœ… å…è®¸ï¼šå°‘é‡çš„é”™åˆ«å­—ï¼ˆå¦‚"å½¢åƒ"vs"å½¢è±¡"ï¼‰ã€æ ‡ç‚¹ç¬¦å·å·®å¼‚ã€æ¢è¡Œä½ç½®ä¸åŒã€‚
   - âœ… å…è®¸ï¼šé¢˜ç›®ä¸­å¤šå‡ºæˆ–å°‘äº†"é˜…è¯»ä¸‹åˆ—ææ–™..."è¿™ç§é€šç”¨æŒ‡ä»¤è¯­ã€‚
   - âŒ ç¦æ­¢ï¼šå…³é”®åè¯ã€äººåã€åœ°åã€æœä»£å‘ç”Ÿå˜åŒ–ã€‚

**åœºæ™¯ä¸‰ï¼šé€šç”¨è§†è§‰æ ‡å‡†**
- âœ… å…è®¸ï¼šæ¸…æ™°åº¦å·®å¼‚ã€æ°´å°ã€æ‰‹å†™ç—•è¿¹ã€æ’ç‰ˆå·®å¼‚ã€‚
- âœ… å…è®¸ï¼šå›¾ç‰‡æˆªå›¾èŒƒå›´ä¸åŒï¼ˆéƒ¨åˆ†é¢˜ç›®å¯èƒ½åŒ…å«é¢˜å·ï¼Œéƒ¨åˆ†å¯èƒ½ä¸åŒ…å«ï¼‰ã€‚
- âŒ ç¦æ­¢ï¼šå›¾ç‰‡å†…å®¹ä¸»ä½“ç‰¹å¾ä¸ä¸€è‡´ï¼ˆå¦‚åœ°å›¾ã€æ’å›¾çš„ä¸»è¦å…ƒç´ ï¼‰ã€‚

**ã€é‡è¦ã€‘ç›®æ ‡é¢˜ç›®æ˜¯æˆªå›¾ï¼Œå€™é€‰é¢˜ç›®æœ‰æ–‡å­—å†…å®¹**
- è¯·å°†ç›®æ ‡é¢˜ç›®æˆªå›¾ä¸­çš„å†…å®¹ä¸å€™é€‰é¢˜ç›®çš„æ–‡å­—å†…å®¹ï¼ˆcontentå­—æ®µï¼‰å’Œå›¾ç‰‡è¿›è¡Œå¯¹æ¯”ã€‚
- å€™é€‰é¢˜ç›®çš„ content å­—æ®µå·²ç»åŒ…å«äº†é¢˜ç›®çš„æ–‡å­—å†…å®¹ï¼Œè¯·ä¸ç›®æ ‡æˆªå›¾ä¸­çš„æ–‡å­—è¿›è¡Œæ¯”å¯¹ã€‚

ã€æœ€ç»ˆå†³ç­–ã€‘
- **åŒ¹é…**ï¼šåªæœ‰å½“é¢˜ç›®çš„**æ ¸å¿ƒè€ƒç‚¹ã€æ•°æ®/æ–‡æœ¬ä¸»ä½“ã€è®¾é—®æ–¹å¼**å‡ä¸€è‡´æ—¶ï¼Œæ‰è§†ä¸ºåŒ¹é…ã€‚
- **ä¸åŒ¹é…**ï¼šä»»ä½•æ ¸å¿ƒè¦ç´ çš„æ”¹åŠ¨ï¼ˆå“ªæ€•æ˜¯å¾ˆå°çš„æ”¹åŠ¨ï¼‰ï¼Œåªè¦æ”¹å˜äº†é¢˜ç›®çš„ç­”æ¡ˆæˆ–è§£æ³•ï¼Œå‡è§†ä¸ºæ”¹ç¼–é¢˜ï¼Œè¿”å› Noneã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘
- æ‰¾åˆ°ä¸¥æ ¼åŒ¹é…çš„åŸé¢˜ï¼šä»…è¿”å›è¯¥å€™é€‰é¡¹ç›®çš„ `index` æ•°å­—ï¼ˆä¾‹å¦‚ï¼š0ï¼‰ã€‚
- æœªæ‰¾åˆ°ä¸¥æ ¼åŒ¹é…ï¼šä»…è¿”å›å­—ç¬¦ä¸² `None`ã€‚
- **ä¸¥ç¦è¾“å‡ºä»»ä½•å¤šä½™å­—ç¬¦ã€‚**

å†æ¬¡å¼ºè°ƒï¼ï¼ï¼ã€è¾“å‡ºæ ¼å¼ã€‘
- æ‰¾åˆ°ä¸¥æ ¼åŒ¹é…çš„åŸé¢˜ï¼šä»…è¿”å›è¯¥å€™é€‰é¡¹ç›®çš„ `index` æ•°å­—ï¼ˆä¾‹å¦‚ï¼š0ï¼‰ã€‚
- æœªæ‰¾åˆ°ä¸¥æ ¼åŒ¹é…ï¼šä»…è¿”å›å­—ç¬¦ä¸² `None`ã€‚
- **ä¸¥ç¦è¾“å‡ºä»»ä½•å¤šä½™å­—ç¬¦ã€‚**

ä½ ä»–å¦ˆæ„Ÿå¤šè¾“å‡ºäº†æˆ‘å°±ç‚¸ä½ 
"#,
        all_images_to_send.len(),
        candidates_json
    );

    debug!("æ„å»ºæ¶ˆæ¯å®Œæˆ: å…± {} å¼ å›¾ç‰‡", all_images_to_send.len());
    debug!("å€™é€‰é¢˜ç›®æ•°é‡: {}", search_results.len());

    (user_message, system_message, all_images_to_send)
}
